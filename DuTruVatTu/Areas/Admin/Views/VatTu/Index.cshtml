@{
    ViewBag.Title = "Vật tư";
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
}
@using DuTruVatTu.Models;
@{ 
    IEnumerable<NhomLinhVucModel> lsNhomLinhVuc = ViewData["DSNhomLinhVuc"] as IEnumerable<NhomLinhVucModel>;
}
<div class="col-md-12">
    <div class="card">
        <div class="card-header">
            <div class="card-title">
                THÔNG TIN / VẬT TƯ
            </div>
            <p class="category">Quản lý thông tin vật tư bao gồm tra cứu, thêm và cập nhật.</p>
        </div>
        <div class="card-content">
            <div class="row">
                <div class="col-md-12">
                    <div class="from-group">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="from-group">
                                    <label>Lĩnh vực</label>
                                    <select class="form-control sel-nhom-linh-vuc">
                                        @foreach (var item in lsNhomLinhVuc)
                                        {
                                            <option value="@item.MSNHOMLINHVUC">@item.TENNHOMLINHVUC</option>
                                        }
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="from-group">
                                    <label>Nhóm vật tư</label>
                                    <select class="form-control sel-nhom-vat-tu"></select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <table class="table">
                        <thead>
                            <tr>
                                <th class="w-5 text-center">STT</th>
                                <th class="w-7">HÌNH ẢNH</th>
                                <th class="w-7">TÊN VẬT TƯ</th>
                                <th class="w-7">ĐƠN VỊ TÍNH</th>
                                <th class="w-7 text-center">THAO TÁC</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<a class="float">
    <span class="ti-plus icon-float" id="btnthem"></span>
</a>

<div class="modal fade" id="modal-them" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Thêm vật tư</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-12">
                        <label>Tên vật tư</label>
                        <input class="form-control them-ten-vat-tu" />
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <label>Đơn vị tính</label>
                        <select class="form-control sel-them-don-vi-tinh">
                            <option value="Cái">Cái</option>
                            <option value="Bộ">Cái</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label>Hình ảnh</label>
                        <br />
                        <button style="margin-top:-1px;" type="button" class="btn btn-success btn-mo-modal-img">Insert image</button>
                    </div>
                </div>
                <div class="row"> 
                    <div class="col-md-12 text-center">
                        <img src="~/Public/Images/300.png" alt="Alternate Text" class="img-vat-tu"/>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-success btn-them">Thêm</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modal-cap-nhat" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Cập nhật phòng</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-12">
                        <label>Tên vật tư</label>
                        <input class="form-control cn-ten-vat-tu" />
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <label>Đơn vị tính</label>
                        <select class="form-control sel-cn-don-vi-tinh">
                            <option value="Cái">Cái</option>
                            <option value="Bộ">Cái</option>
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <label>Hình ảnh</label><br /><br />
                        <div id="page">
                            <div class="wrap-custom-file">
                                <input type="file" name="image2" id="image2" accept=".gif, .jpg, .png" />
                                <label for="image2" id="cn-anh">
                                    <span>Chọn ảnh linh kiện</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-success btn-cap-nhat">Cập nhật</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modal-xoa" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-body">
                <div class="row" style="margin-top: 35px;">
                    <div class="col-md-3">
                        <span class="ti-eraser icon-xoa-modal"></span>
                    </div>
                    <div class="col-md-9">
                        <h5>Bạn chắc chứ ?</h5>
                        <div class="body-title-xoa">Khi xóa, thông tin sẽ không thể phục hồi lại được.</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" data-dismiss="modal">Đóng</button>
                <button type="button" id="btn-xoa-chuc-vu" class="btn btn-danger">Xóa</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modal-load-anh" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content" style="height: 500px;">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">ẢNH VẬT TƯ</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-12">
                        <ul class="nav nav-tabs" role="tablist">
                            <li class="nav-item">
                                <a class="nav-link active" href="#thuvienanh" role="tab" data-toggle="tab">Thư viện ảnh</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#themanh" role="tab" data-toggle="tab">Thêm ảnh</a>
                            </li>
                        </ul>
                        <hr />
                    </div>
                    <div class="col-md-12">
                        <div class="tab-content">
                            <div role="tabpanel" class="tab-pane fade in active show" id="thuvienanh">
                                <div class="row list-thu-vien-anh" >
                                    <div class="col-md-2">
                                        <input type="checkbox" class="chk-img-vat-tu"/>
                                        <img src="~/Uploads/21740498_878883312277596_1367665388262135781_n.jpg" alt="Alternate Text" style='width:100%' />
                                    </div>
                                </div>
                            </div>
                            <div role="tabpanel" class="tab-pane fade" id="themanh">
                                <div class="row">
                                    <div class="col-md-12">
                                        <div id="page">
                                            <div class="wrap-custom-file">
                                                <input type="file" name="image1" id="image1" accept=".gif, .jpg, .png" />
                                                <label for="image1">
                                                    <span>Chọn ảnh linh kiện</span>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" data-dismiss="modal">Đóng</button>
                <button type="button" id="btn-xoa-chuc-vu" class="btn btn-danger">Xóa</button>
            </div>
        </div>
    </div>
</div>
     
<script>
    $(document).ready(function () {
        var _MSVATTU;

        $('input[type="file"]').each(function () {
            var $file = $(this),
                $label = $file.next('label'),
                $labelText = $label.find('span'),
                labelDefault = $labelText.text();
            $file.on('change', function (event) {
                var fileName = $file.val().split('\\').pop(),
                    tmppath = URL.createObjectURL(event.target.files[0]);
                if (fileName) {
                    $label
                        .addClass('file-ok')
                        .css('background-image', 'url(' + tmppath + ')');
                    $labelText.text(fileName);
                } else {
                    $label.removeClass('file-ok');
                    $labelText.text(labelDefault);
                }
            }); 
        });

        function LayDanhSachNhomVatTuTheoLinhVuc(maLinhVuc, tenSel) {
            $.ajax({
                type: "post",
                url: "/NhomVatTu/DSNhomVatTuJSON",
                data: {
                    "__RequestVerificationToken": $('input[name="__RequestVerificationToken"]').val(),
                    "msNhomLinhVuc": maLinhVuc
                },
                success: function (data) {
                    var dl = $.parseJSON(data);
                    var item = "";
                    for (i = 0; i < dl.length; i++) {
                        item += "<option value=" + dl[i].MSNHOMVATTU + ">" + dl[i].TENNHOMVATTU + "</option>";
                    }
                    $(tenSel).empty();
                    $(tenSel).append(item);
                }
            });
        }

        function LayDanhSachVatTuTheoNhomVatTu(maNhomVatTu, tenSel) {
            if (maNhomVatTu >0) {
                $.ajax({
                    type: "post",
                    url: "/VatTu/DSVatTuJSON",
                    data: {
                        "msNhomVatTu": maNhomVatTu
                    },
                    success: function (data) {
                        var dl = $.parseJSON(data);
                        var item = "";
                        for (i = 0; i < dl.length; i++) {
                            item += "<tr>";
                            item += "<td class='w-5 text-center'>" + (i + 1) + "</td>";
                            item += "<td id=avt-" + dl[i].MSVATTU + "><img src='.." + dl[i].HINHANH + "' style='width: 40px;height: 40px;'/></td>";
                            item += "<td id=tvt-" + dl[i].MSVATTU + ">" + dl[i].TENVATTU + "</td>";
                            item += "<td id=dvt-" + dl[i].MSVATTU + ">" + dl[i].DONVITINH + "</td>";
                            item += "<td class='text-center'> <button class='btn btn-success edit btn-cn' value='" + dl[i].MSVATTU
                                + "'><span class='ti-pencil'></span></button> <button class='btn btn-danger edit btn-xoa' value='" + dl[i].MSVATTU
                                + "'><span class='ti-close'></span></button></td>";
                            item += "</tr>";
                        }
                        $(tenSel).empty();
                        $(tenSel).append(item);
                    }
                });
            }            
        }

        function LayDanhSachHinhAnh(control) {
            $.ajax({
                type: "post",
                url: "/LoadAnh/LoadAnhAjax",
                success: function (data) {
                    var dl = $.parseJSON(data);
                    var item = "";
                    for (i = 0; i < dl.length; i++) {
                        item += "<div class='col-2'>";
                        item += "<input type='checkbox' class='chk-img-vat-tu' />";
                        item += "<img src='" + dl[i].URL + "' alt='Alternate Text' class='img-vat-tu' />";
                        item += "</div>"
                    }
                    $(control).empty();
                    $(control).append(item);
                }
            });
        }

        $('.sel-nhom-linh-vuc, .sel-nhom-vat-tu').change(function () {
            LayDanhSachNhomVatTuTheoLinhVuc($('.sel-nhom-linh-vuc').val(), ".sel-nhom-vat-tu");
            LayDanhSachVatTuTheoNhomVatTu($('.sel-nhom-vat-tu').val(), "tbody");
        });

        $('#btnthem').click(function () {
            $('#modal-them').modal('show');
        });

        function UploadImage(data) {
            var temp;
            $.ajax({
                type: "POST",
                url: '/VatTu/Upload',
                data: data,
                async: false,
                contentType: false,
                processData: false,
                success: function (result) {
                    temp = result;
                },
                error: function (error) { console.log(eror); }
            });
            return temp;
        }

        $('.btn-them').click(function () {
            var formData = new FormData();
            var totalFiles = document.getElementById("image1").files.length;
            for (var i = 0; i < totalFiles; i++) {
                var file = document.getElementById("image1").files[i];
                formData.append("image1", file);
            }
            var urlImage = UploadImage(formData);
            alert(urlImage);
            $.ajax({
                type: "post",
                url: "/VatTu/Them",
                data: {
                    "msNhomVatTu": $('.sel-nhom-vat-tu').val(),
                    "tenVatTu": $('.them-ten-vat-tu').val(),
                    "donViTinh": $('.sel-them-don-vi-tinh').val(),
                    "urlHinhAnh": urlImage,
                },
                success: function (data) {
                    LayDanhSachNhomVatTuTheoLinhVuc($('.sel-nhom-linh-vuc').val(), ".sel-nhom-vat-tu");
                }
            });
        });

        $(document).on('click', '.btn-cn', function () {
            _MSVATTU = $(this).val();
            $('.cn-ten-vat-tu').val($('#tvt-' + _MSVATTU).text());
            $('.sel-cn-don-vi-tinh').val($('#dvt-' + _MSVATTU).text());
            alert($('#avt-' + _MSVATTU + " img").attr('src'));
            $('#cn-anh').css('background-image', 'url(' + $('#avt-' + _MSVATTU + " img").attr('src') + ')');
            $('#cn-anh').addClass('file-ok');
            $('#modal-cap-nhat').modal('show');
        });

        $(document).on('click', '.btn-xoa', function () {
            $('#modal-load-anh').modal('show');
        });

        $('.btn-mo-modal-img').click(function () {
            LayDanhSachHinhAnh('.list-thu-vien-anh');
            $('#modal-load-anh').modal('show');
        });
    });
</script>